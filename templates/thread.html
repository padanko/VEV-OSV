<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEV</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="body">

    <!-- 固定ナビゲーション -->
    <div class="position-fixed top-50 end-0 translate-middle-y d-flex flex-column me-3 body" style="z-index: 100;">
        <a href="#title__" class="btn btn-primary mb-2">▲</a>
        <a href="#form__" class="btn btn-danger">▼</a>
    </div>

    <div class="container mt-5 body">
        <div class="thread-card body">
            <h1 id="title__" class="text-danger">{{thread.title}}</h1>
            <small class="text-muted">{{thread.thrid}}</small><br>
            <a href="/{{instance_id}}" class="btn btn-secondary btn-sm">掲示板に戻る</a>
            <a href="/" class="btn btn-secondary btn-sm">VEV</a>

            <hr>

            <!-- スレッド内容 -->
            <div id="thr">
                {% for item in thread.contents %}
                <div class="response body" id="r{{loop.index}}">
                    <strong><a onclick="reply('{{loop.index}}')" class="body reply-button text-primary">{{loop.index}}</a>:
                        <span class="body">{{item.name}}</span>　
                        <small class="body ">{{item.timestamp}}　{{item.id}}</small>
                    </strong>
                    <pre class="body">{{render(item.text)|safe}}</pre>
                </div>
                {% endfor %}
            </div>

            <a href="/{{instance_id}}" class="btn btn-secondary btn-sm">掲示板に戻る</a>
            <a href="/" class="btn btn-secondary btn-sm">VEV</a>
        </div>

        <!-- 投稿フォーム -->
        <div class="card mt-4" id="form__">
            <div class="card-body body">
                <h5 class="card-title">コメントを投稿</h5>
                <div class="mb-2">
                    <label for="name" class="form-label">お名前</label>
                    <input type="text" id="name" class="form-control">
                </div>
                <div class="mb-2">
                    <label for="text" class="form-label">メッセージ</label>
                    <textarea id="text" class="form-control" rows="3"></textarea>
                </div>
                <button id="submit" class="btn btn-primary w-100">投稿</button>
            </div>
        </div>
    </div>
    <br>
    <br>
    <br>
    <!-- フッター -->
    <div class="bottom-nav mt-4 text-center bg-dark text-white py-3 position-fixed" style="bottom:0px; width:100vw">
        <a href="/{{instance_id}}/" class="btn btn-primary">🏡 ホーム</a>
        <span class="mx-2"></span>
        <a href="/" class="btn btn-primary">🏡 VEV</a>
        <span class="mx-2"></span>
        <button id="dark-change" class="btn btn-secondary">ダークモード</button>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        $("#submit").click(() => {
            $.ajax({
                url: "/{{instance_id}}/mkrsp/{{thread.thrid}}",
                type: "POST",
                data: {
                    name: $("#name").val(),
                    text: $("#text").val()
                },
                success: () => {
                    $("#text").val("");
                }
            })
        });

        function poll() {
            fetch("/{{instance_id}}/poll/{{thread.thrid}}")
                .then((d) => d.json())
                .then((data) => {
                    var element = document.createElement("div");
                    element.className = "body response";
                    element.id = `r${data.index}`
                    element.innerHTML = `
                        <strong><a onclick="reply('${data.index}')" class="reply-button text-primary body">${data.index}</a>:
                        <span class="body">${data.name}</span>　
                        <small class="body">${data.timestamp}　${data.id}</small>
                        </strong>
                        <pre class="body">${data.text}</pre>
                    `;
                    $("#thr")[0].appendChild(element);
                    dark_mode_change()
                    poll();
                })
                .catch((e) => {
                    console.error("error", e);
                    setTimeout(poll, 1000);
                });
        }

        poll();

        function reply(c) {
            $("#text").val(`>>${c}\n${$("#text").val()}`)
        }

        var isdark = localStorage.getItem("darkmode") == "true"

        function dark_mode_change() {
            if ( isdark ) {
                document.querySelectorAll(".body").forEach((d)=>{
                    d.style.backgroundColor = "#fff"
                    d.style.color = "#111"
                })

    
            } else {
                document.querySelectorAll(".body").forEach((d)=>{
                    d.style.backgroundColor = "#222"
                    d.style.color = "#fff"
                    
                })
    
            }
        }
        
        dark_mode_change()

        $("#dark-change").click(()=>{
            isdark = !isdark
            dark_mode_change()
            localStorage.setItem("darkmode", isdark)
        })
    </script>

</body>
</html>
